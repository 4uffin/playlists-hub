<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Playlist Hub</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f5f7fa;
      color: #222;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #6c63ff;
      color: white;
      padding: 1rem 2rem;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    button, select {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    button {
      background: white;
      color: #6c63ff;
      font-weight: 600;
    }

    button:hover {
      background: #ecebff;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      padding: 1rem;
    }

    .playlist {
      background: white;
      padding: 1.5rem;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 600px;
      width: 100%;
    }

    .playlist h3 {
      margin-top: 0;
    }

    .embed iframe {
      width: 100%;
      height: 300px;
      border-radius: 10px;
      border: none;
    }

    .user-info {
      display: flex;
      align-items: center;
      margin-top: 1rem;
      gap: 0.5rem;
    }

    .user-info img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid #ccc;
    }

    .user-info a {
      color: #6c63ff;
      text-decoration: none;
      font-weight: 600;
    }

    .user-info a:hover {
      text-decoration: underline;
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 10;
    }

    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 2rem;
      border-radius: 14px;
      width: 90%;
      max-width: 600px;
      position: relative;
    }

    .close {
      position: absolute;
      right: 1rem;
      top: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
    }

    textarea, input {
      width: 100%;
      padding: 0.6rem;
      margin: 0.4rem 0 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .output textarea {
      width: 100%;
      height: 160px;
      margin-top: 0.5rem;
    }

    .user-preview {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.75rem 0 1rem 0;
      padding: 0.75rem;
      background: #f6f6f6;
      border-radius: 10px;
      border: 1px solid #ddd;
      transition: all 0.3s ease;
    }

    .user-preview img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .user-preview a {
      color: #6c63ff;
      font-weight: 600;
      text-decoration: none;
    }

    .user-preview a:hover {
      text-decoration: underline;
    }

    @media (min-width: 768px) {
      main {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      .playlist {
        flex: 1 1 300px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸŽµ Playlist Hub</h1>
    <div class="controls">
      <button id="addPlaylistBtn">+ Add Playlist</button>
      <select id="sortSelect">
        <option value="recent">Sort: Most Recent</option>
        <option value="name">Sort: Name (Aâ€“Z)</option>
      </select>
    </div>
  </header>

  <main id="playlistContainer"></main>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Add New Playlist</h2>
      <form id="playlistForm">
        <label for="name">Playlist Name</label>
        <input type="text" id="name" placeholder="Enter playlist name" required />

        <label for="description">Description</label>
        <textarea id="description" placeholder="Short description" required></textarea>

        <label for="username">GitHub Username</label>
        <input type="text" id="username" placeholder="e.g. 4uffin" />
        <div id="userPreview" class="user-preview">
          <p>Type your GitHub username to preview your profile</p>
        </div>

        <label for="embeds">Playlist Embeds (one per line)</label>
        <textarea id="embeds" placeholder="Paste your embed iframe(s)" required></textarea>

        <button type="submit">Generate JSON</button>
      </form>

      <div class="output">
        <h3>Generated Playlist JSON</h3>
        <textarea id="template" readonly></textarea>
        <p>Commit this file to your <code>/playlists</code> folder.</p>
      </div>
    </div>
  </div>

  <script>
    const container = document.getElementById("playlistContainer");
    const addPlaylistBtn = document.getElementById("addPlaylistBtn");
    const modal = document.getElementById("modal");
    const closeBtn = document.querySelector(".close");
    const playlistForm = document.getElementById("playlistForm");
    const template = document.getElementById("template");
    const sortSelect = document.getElementById("sortSelect");

    const usernameInput = document.getElementById("username");
    const userPreview = document.getElementById("userPreview");

    let userInfo = { username: "", profile_url: "", avatar_url: "" };

    // Load playlists
    async function loadPlaylists() {
      try {
        const res = await fetch("https://api.github.com/repos/4uffin/playlists-hub/contents/playlists");
        const files = await res.json();

        const playlists = await Promise.all(
          files.filter(f => f.name.endsWith(".json")).map(async file => {
            const data = await fetch(file.download_url);
            return await data.json();
          })
        );

        const sortType = localStorage.getItem("playlistSort") || "recent";
        sortSelect.value = sortType;

        if (sortType === "name") {
          playlists.sort((a, b) => a.name.localeCompare(b.name));
        } else {
          playlists.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
        }

        renderPlaylists(playlists);
      } catch (err) {
        console.error("Error fetching playlists:", err);
      }
    }

    function renderPlaylists(playlists) {
      container.innerHTML = "";
      playlists.forEach(p => {
        const div = document.createElement("div");
        div.className = "playlist";
        div.innerHTML = `
          <h3>${p.name}</h3>
          <p>${p.description}</p>
          <div class="embed">
            ${p.embeds.map(e => e.iframe).join("")}
          </div>
          ${p.user ? `
            <div class="user-info">
              <img src="${p.user.avatar_url || ''}" alt="${p.user.username}" />
              <a href="${p.user.profile_url}" target="_blank">@${p.user.username}</a>
            </div>` : ""}
        `;
        container.appendChild(div);
      });
    }

    sortSelect.addEventListener("change", () => {
      localStorage.setItem("playlistSort", sortSelect.value);
      loadPlaylists();
    });

    // Modal logic
    addPlaylistBtn.onclick = () => modal.style.display = "block";
    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

    // GitHub user preview
    usernameInput.addEventListener("input", async e => {
      const username = e.target.value.trim();
      if (!username) {
        userPreview.innerHTML = "<p>Type your GitHub username to preview your profile</p>";
        userInfo = { username: "", profile_url: "", avatar_url: "" };
        return;
      }

      userPreview.innerHTML = "<p>Loading...</p>";
      try {
        const res = await fetch(`https://api.github.com/users/${username}`);
        if (!res.ok) throw new Error("User not found");
        const data = await res.json();

        userInfo = {
          username: data.login,
          profile_url: data.html_url,
          avatar_url: data.avatar_url
        };

        userPreview.innerHTML = `
          <img src="${data.avatar_url}" alt="${data.login}" />
          <a href="${data.html_url}" target="_blank">@${data.login}</a>
        `;
      } catch {
        userPreview.innerHTML = `<p style="color:red;">User not found or API limit reached</p>`;
        userInfo = { username, profile_url: "", avatar_url: "" };
      }
    });

    // Form submission
    playlistForm.addEventListener("submit", e => {
      e.preventDefault();

      const embedsArray = document.getElementById("embeds").value
        .split("\n")
        .filter(line => line.trim() !== "")
        .map((iframe, i) => ({ title: `Embed ${i+1}`, iframe }));

      const playlistJSON = {
        name: document.getElementById("name").value.trim(),
        description: document.getElementById("description").value.trim(),
        embeds: embedsArray,
        user: {
          username: userInfo.username || "unknown",
          profile_url: userInfo.profile_url || "",
          avatar_url: userInfo.avatar_url || ""
        },
        date: new Date().toISOString()
      };

      template.value = JSON.stringify(playlistJSON, null, 2);
    });
    
    loadPlaylists();
  </script>
</body>
</html>
